#### TF

Лучшие практики использования Terraform:

1. **Хранение инфраструктуры в виде кода (IaC)**:
   - Всю инфраструктуру описывайте в коде, чтобы обеспечить прозрачность, контроль версий и возможность повторного использования.
   - Используйте систему контроля версий (например, Git) для отслеживания изменений.

2. **Организация кода в модули**:
   - Разделяйте код на модули для повторного использования. Модули помогают организовать инфраструктурный код и упрощают поддержку.
   - Пример структуры модуля:
     ```
     modules/
       vpc/
       ec2/
       s3/
     ```

3. **Использование переменных и переменных окружения**:
   - Используйте переменные для параметризации конфигураций и обеспечения гибкости. Это позволяет легко переключаться между разными средами (production, staging).
   - Используйте файлы переменных для разных сред (например, `terraform.tfvars`).

4. **Использование `terraform.tfstate` с блокировкой**:
   - Настройте хранение состояния Terraform в удалённом бэкэнде (например, AWS S3) с функцией блокировки (DynamoDB), чтобы избежать конфликтов при одновременных изменениях.
   - Всегда проверяйте состояние перед применением изменений.

5. **Избегайте хранения конфиденциальных данных в коде**:
   - Никогда не храните пароли или секретные ключи в Terraform-коде. Используйте Terraform Vault, переменные окружения или сторонние системы управления секретами.

6. **Планирование изменений перед их применением**:
   - Всегда используйте команду `terraform plan`, чтобы увидеть, какие изменения будут внесены до их применения. Это помогает избежать неожиданных изменений.
   - Команда:
     ```bash
     terraform plan
     ```

7. **Минимизация прав доступа**:
   - Ограничивайте права Terraform на создание и изменение ресурсов до минимально необходимых. Это повышает безопасность и снижает риски.

8. **Разделение ресурсов по рабочим пространствам (workspaces)**:
   - Используйте рабочие пространства для разделения инфраструктуры между разными средами (dev, staging, production), чтобы избежать пересечения ресурсов и конфликтов.
   - Пример:
     ```bash
     terraform workspace new production
     ```

9. **Использование блоков `lifecycle`**:
   - Используйте блоки `lifecycle` для управления жизненным циклом ресурсов, чтобы предотвратить случайное удаление важных ресурсов.
   - Пример:
     ```hcl
     resource "aws_instance" "example" {
       lifecycle {
         prevent_destroy = true
       }
     }
     ```

10. **Документирование инфраструктуры**:
    - Документируйте структуру модулей, используемые переменные и архитектуру. Это упрощает поддержку и передачу проекта другим инженерам.

11. **Регулярное обновление провайдеров и модулей**:
    - Следите за обновлениями Terraform и модулей, чтобы использовать последние функции и исправления безопасности. Обновляйте зависимости с осторожностью, тестируя их на стейджинге.

12. **Использование локальных переменных для удобочитаемости**:
    - Используйте локальные переменные (`locals`) для упрощения сложных выражений и улучшения читаемости кода.
    - Пример:
     ```hcl
     locals {
       instance_type = "t2.micro"
     }
     ```

13. **Автоматизация через CI/CD**:
    - Включите Terraform в CI/CD pipeline для автоматического развертывания инфраструктуры при изменении кода. Это обеспечивает непрерывную интеграцию и контроль изменений.

Эти лучшие практики помогут поддерживать чистоту и эффективность вашего Terraform-кода, улучшат безопасность и сделают инфраструктуру более управляемой.

----

Основные сущности и понятия в Terraform:

1. **Providers (Провайдеры)**:
   - Провайдеры отвечают за взаимодействие Terraform с различными облачными платформами и сервисами. Каждый провайдер предлагает ресурсы для управления инфраструктурой.
   - Примеры: AWS, Google Cloud, Azure, Kubernetes.
   - Пример:
     ```hcl
     provider "aws" {
       region = "us-west-1"
     }
     ```

2. **Resources (Ресурсы)**:
   - Ресурсы — это основные компоненты инфраструктуры, которые Terraform создаёт и управляет ими. Каждый ресурс соответствует объекту инфраструктуры (например, виртуальная машина, база данных, сеть).
   - Пример:
     ```hcl
     resource "aws_instance" "example" {
       ami           = "ami-123456"
       instance_type = "t2.micro"
     }
     ```

3. **Modules (Модули)**:
   - Модули представляют собой повторно используемые блоки конфигураций, которые можно использовать для создания сложных архитектур с простыми интерфейсами. Модули помогают организовать и повторно использовать код.
   - Пример:
     ```hcl
     module "vpc" {
       source = "./modules/vpc"
     }
     ```

4. **Variables (Переменные)**:
   - Переменные используются для параметризации конфигураций, позволяя изменять значения в зависимости от среды или требований. Значения переменных можно передавать через файлы переменных или командную строку.
   - Пример:
     ```hcl
     variable "instance_type" {
       default = "t2.micro"
     }
     ```

5. **Outputs (Выходные значения)**:
   - Выходные значения используются для экспорта данных, созданных в процессе выполнения Terraform. Эти значения могут быть использованы другими модулями или отображены пользователю.
   - Пример:
     ```hcl
     output "instance_ip" {
       value = aws_instance.example.public_ip
     }
     ```

6. **State (Состояние)**:
   - Состояние (state) — это файл, в котором Terraform хранит текущее состояние инфраструктуры. Он используется для сравнения запланированных изменений с текущим состоянием, чтобы Terraform мог понять, что нужно изменить.
   - Хранится локально или в удалённых хранилищах (S3, GCS).
   - Пример команды для просмотра состояния:
     ```bash
     terraform show
     ```

7. **Backend (Бэкэнд)**:
   - Бэкэнд отвечает за хранение файла состояния. Он может быть локальным или удалённым (например, S3, GCS, Consul). Использование удалённого бэкэнда позволяет нескольким пользователям работать с одним и тем же состоянием инфраструктуры.
   - Пример:
     ```hcl
     backend "s3" {
       bucket = "my-bucket"
       key    = "path/to/my/terraform.tfstate"
       region = "us-west-1"
     }
     ```

8. **Providers Block (Блок провайдера)**:
   - Блок провайдера определяет, какой провайдер будет использоваться для взаимодействия с API платформы и какие настройки (например, регион, доступы) для этого потребуются.
   - Пример:
     ```hcl
     provider "aws" {
       region = "us-west-1"
     }
     ```

9. **Data Sources (Источники данных)**:
   - Источники данных позволяют Terraform получать информацию о существующих ресурсах, которые были созданы за пределами Terraform, или данных, предоставленных внешними сервисами.
   - Пример:
     ```hcl
     data "aws_ami" "example" {
       most_recent = true
       owners      = ["self"]
     }
     ```

10. **Provisioners (Провиженеры)**:
    - Провиженеры позволяют выполнять скрипты или команды на созданных ресурсах после их развертывания. Они обычно используются для дополнительных конфигураций на серверах (например, запуск скриптов и инсталляций ПО).
    - Пример:
      ```hcl
      resource "aws_instance" "example" {
        provisioner "remote-exec" {
          inline = [
            "sudo apt-get update",
            "sudo apt-get install -y nginx"
          ]
        }
      }
      ```

11. **Terraform Plan**:
    - Команда, которая генерирует и показывает план изменений перед их применением. Используется для проверки, какие ресурсы будут созданы, изменены или удалены.
    - Пример команды:
      ```bash
      terraform plan
      ```

12. **Terraform Apply**:
    - Команда, которая применяет изменения к инфраструктуре в соответствии с планом, генерируемым Terraform.
    - Пример команды:
      ```bash
      terraform apply
      ```

13. **Terraform Destroy**:
    - Команда, которая удаляет все ресурсы, созданные Terraform. Полезна для полного удаления инфраструктуры.
    - Пример команды:
      ```bash
      terraform destroy
      ```

14. **Workspaces (Рабочие пространства)**:
    - Рабочие пространства позволяют разделять состояния для одной и той же конфигурации. Например, можно использовать разные рабочие пространства для `dev` и `prod`.
    - Пример команды:
      ```bash
      terraform workspace new dev
      ```

15. **Lifecycle (Жизненный цикл ресурсов)**:
    - Управление жизненным циклом ресурсов с помощью блоков `lifecycle`. Это позволяет контролировать такие аспекты, как предотвращение удаления ресурса или его замена.
    - Пример:
      ```hcl
      resource "aws_instance" "example" {
        lifecycle {
          prevent_destroy = true
        }
      }
      ```

Эти сущности и понятия являются основой работы с Terraform и позволяют эффективно управлять инфраструктурой.

